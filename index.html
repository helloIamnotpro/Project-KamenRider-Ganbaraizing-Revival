<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ganbarizing Card Scanner</title>
<style>
  body {
    background: #111;
    color: white;
    text-align: center;
    font-family: sans-serif;
  }
  video, canvas {
    width: 80%;
    max-width: 400px;
    border-radius: 12px;
    margin-top: 10px;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    background: #0f0;
    color: black;
    font-weight: bold;
    cursor: pointer;
  }
  button:disabled {
    background: #444;
    color: #888;
    cursor: not-allowed;
  }
  #result {
    margin-top: 20px;
    font-size: 1.2em;
    color: #0f0;
  }
</style>
</head>
<body>
<h2>Ganbarizing Card Scanner</h2>
<video id="camera" autoplay playsinline></video>
<canvas id="snap" style="display:none;"></canvas>
<br>
<button id="scanBtn" disabled>ðŸ“¸ Scan Card</button>
<p id="status">ðŸ“· Initializing camera...</p>
<p id="result"></p>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("snap");
const ctx = canvas.getContext("2d");
const scanBtn = document.getElementById("scanBtn");
const statusText = document.getElementById("status");
const resultText = document.getElementById("result");

let refs = [];

// automatically load all files in "cards" folder
async function loadReferences() {
  try {
    const res = await fetch("cards/");
    const html = await res.text();
    const matches = [...html.matchAll(/href="([^"]+\.(jpg|jpeg|png))"/gi)];
    for (const m of matches) {
      const path = "cards/" + m[1];
      const img = new Image();
      img.src = path;
      await new Promise(r => img.onload = r);
      refs.push({ name: m[1].replace(/\.[^.]+$/, ""), img });
    }
    console.log("Loaded", refs.length, "cards");
  } catch (e) {
    console.error("Could not load cards folder", e);
  }
}

async function setupCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;
  return new Promise(r => video.onloadedmetadata = r);
}

// compare two images
function compareImages(img1, img2) {
  const w = 64, h = 64;
  const c1 = document.createElement("canvas");
  const c2 = document.createElement("canvas");
  [c1.width, c1.height, c2.width, c2.height] = [w, h, w, h];
  const x1 = c1.getContext("2d"), x2 = c2.getContext("2d");
  x1.drawImage(img1, 0, 0, w, h);
  x2.drawImage(img2, 0, 0, w, h);
  const d1 = x1.getImageData(0, 0, w, h).data;
  const d2 = x2.getImageData(0, 0, w, h).data;
  let diff = 0;
  for (let i = 0; i < d1.length; i += 4) {
    diff += Math.abs(d1[i] - d2[i]) + Math.abs(d1[i+1] - d2[i+1]) + Math.abs(d1[i+2] - d2[i+2]);
  }
  return diff / (w*h*3);
}

async function captureAndCompare() {
  statusText.textContent = "ðŸ” Scanning...";
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const snap = new Image();
  snap.src = canvas.toDataURL();
  await new Promise(r => snap.onload = r);

  let best = null;
  let bestScore = Infinity;
  for (const ref of refs) {
    const score = compareImages(snap, ref.img);
    if (score < bestScore) {
      bestScore = score;
      best = ref.name;
    }
  }

  if (best) {
    resultText.textContent = "ðŸƒ Best match: " + best;
    statusText.textContent = "âœ… Scan complete!";
  } else {
    resultText.textContent = "";
    statusText.textContent = "âŒ No cards found.";
  }
}

(async () => {
  await loadReferences();
  await setupCamera();
  statusText.textContent = "ðŸ“· Ready â€” hold a card up and press scan.";
  scanBtn.disabled = false;
})();

scanBtn.addEventListener("click", captureAndCompare);
</script>
</body>
</html>
